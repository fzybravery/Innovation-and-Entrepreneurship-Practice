# 图像数字水印系统

## 1. 项目介绍

本项目旨在实现一个基于离散余弦变换 (DCT) 的图像数字水印系统。数字水印是一种将特定信息（如版权信息、作者身份等）嵌入到数字媒体中而不影响其感知质量的技术。其主要目的是为了版权保护、认证和溯源。本系统不仅实现了水印的嵌入和提取功能，还通过引入多种常见的图像处理操作，对水印的鲁棒性进行了全面测试和评估。

---

## 2. 基本原理

本数字水印系统主要利用频域变换的方法来嵌入水印。

### 2.1 亮度分量与颜色空间

人类视觉系统对图像亮度的变化比对色彩的变化更为敏感。因此，将水印信息嵌入到图像的亮度分量 (Y) 中，可以在保证水印不可见性的同时，获得较好的鲁棒性。本项目采用 YCrCb 颜色空间，其中 Y 代表亮度，Cr 和 Cb 代表色度。

### 2.2 离散余弦变换 (DCT)

DCT 是一种将图像从空间域转换到频域的数学变换。在 DCT 域中，图像信息被分解为不同频率的系数：

- 低频系数：代表图像的平滑区域和主要能量，对图像的整体视觉质量影响最大。
- 中频系数：代表图像的纹理和边缘信息。
- 高频系数：代表图像的细节和噪声。

由于人眼对高频信息的改变不太敏感，而中频系数在保证不可见性的同时，也具有一定的抗攻击能力，因此水印通常嵌入到图像的中频系数中。

### 2.3 水印嵌入过程

- **宿主图像处理**：将宿主图像（待嵌入水印的图像）从 RGB 颜色空间转换为 YCrCb 颜色空间，并提取其亮度 Y 分量。  
- **分块**：将亮度 Y 分量划分为若干个 8×8 像素的小块。  
- **DCT 变换**：对每个 8×8 小块进行二维 DCT 变换，得到其频域系数矩阵。  
- **水印位嵌入**：选择 DCT 块中的特定中频系数（例如 (2,2) 位置）。根据要嵌入的水印比特（0 或 1）：
  - 如果水印比特为 1，则在该中频系数上增加一个预设的强度值 ALPHA。  
  - 如果水印比特为 0，则在该中频系数上减去一个预设的强度值 ALPHA。  
  ALPHA 值决定了水印的强度：值越大，水印越鲁棒但可能越可见；值越小，水印越不可见但鲁棒性越差。  
- **IDCT 逆变换**：对修改后的 DCT 块进行逆 DCT 变换，将其转换回空间域。  
- **合并**：将所有修改后的图像块重新组合成新的亮度 Y 分量，并与原始的 Cr 和 Cb 分量合并，最终转换回 RGB 图像，形成含水印图像。

### 2.4 水印提取过程（盲提取）

- **含水印图像处理**：将含水印图像转换为 YCrCb 颜色空间，并提取其亮度 Y 分量。  
- **分块与 DCT**：与嵌入过程相同，将亮度 Y 分量分块并进行 DCT 变换。  
- **提取水印位**：在与嵌入时完全相同的中频系数位置（例如 (2,2)），检查该系数的值：
  - 如果该系数的值大于一个预设的 EXTRACT_THRESHOLD，则判断提取的水印位为 1。  
  - 否则，判断提取的水印位为 0。  
  EXTRACT_THRESHOLD 的设定至关重要，它通常与 ALPHA 值相关，用于区分被增加或减小的系数。  
- **重构水印**：将所有提取出的比特序列按原始水印的尺寸重构为一幅二值水印图像。

---

## 3. 功能介绍

### 3.1 核心功能

- **水印嵌入**：将用户指定的水印图像（自动转换为二值）以不可见的方式嵌入到宿主图像中，生成含水印图像。  
- **水印提取**：从含水印图像（包括经过各种攻击后的图像）中盲提取嵌入的水印信息，重构为二值水印图像。

### 3.2 鲁棒性测试

本项目针对多种常见的图像攻击对水印的鲁棒性进行了测试和评估：

- **几何攻击**：  
  - 水平翻转：图像沿垂直轴翻转。  
  - 垂直翻转：图像沿水平轴翻转。  
  - 平移：图像在水平和垂直方向上移动。  
  - 裁剪：从图像中截取一部分区域。  
- **信号处理攻击**：  
  - 对比度调整：改变图像的明暗差异。  
  - 亮度调整：改变图像的整体明暗程度。  
  - 高斯噪声：向图像添加随机噪声。  
  - 中值滤波：一种非线性平滑滤波器，常用于去除椒盐噪声。  
  - 高斯模糊：一种线性平滑滤波器，使图像模糊。  
  - JPEG 压缩：有损压缩，模拟图像在传输或存储过程中质量下降。

### 3.3 性能评估指标

- **归一化相关系数 (Normalized Correlation, NC)**：衡量提取水印与原始水印的相似度。NC 值范围在 [-1, 1] 之间，越接近 1 表示相似度越高，水印提取效果越好。  
- **比特错误率 (Bit Error Rate, BER)**：衡量提取水印中错误比特所占的比例。BER 值范围在 [0, 1] 之间，越接近 0 表示错误越少，水印提取效果越好。

### 3.4 结果可视化与报告

- 所有生成的中间图像和最终结果图像都将保存到脚本所在目录下的 `output` 文件夹中。  
- 在控制台输出详细的 NC 和 BER 测试结果。  
- 使用 `matplotlib` 库生成一个可视化汇总图，直观展示原始图像、含水印图像、无攻击提取水印以及部分攻击后图像和对应的提取水印，并标注其 NC 和 BER 值。

---

## 4. 代码功能分析

### 4.1 路径配置与初始化

- `SCRIPT_DIR = os.path.abspath(os.path.dirname(__file__))`：动态获取当前脚本的绝对路径，确保项目在不同环境下都能正确找到输入输出文件。  
- `HOST_IMAGE_PATH`、`WATERMARK_IMAGE_PATH`、`OUTPUT_DIR`：使用 `os.path.join` 拼接路径，保证跨平台的兼容性。所有生成的文件都统一存放在 `SCRIPT_DIR/output/` 目录下。  
- `BLOCK_SIZE`、`ALPHA`、`EXTRACT_THRESHOLD`：全局配置参数，方便调整水印算法的性能。

### 4.2 辅助函数

- `img_to_ycrcb`、`ycrcb_to_rgb`：图像颜色空间转换。  
- `get_block_dct`、`idct_block`：DCT/IDCT 变换。  
- `bin_to_image`、`image_to_bin`：水印的二进制–图像转换逻辑。

### 4.3 评估函数

- `normalize_correlation`、`bit_error_rate`：标准的 NC 和 BER 计算方法，用于量化评估水印的鲁棒性。

### 4.4 核心水印处理函数

- `embed_watermark`：  
  - 读取和二值化水印图像。  
  - 对宿主图像 Y 通道分块并进行 DCT 变换。  
  - 在 (2,2) 处根据水印比特修改 DCT 系数。  
  - 执行 IDCT 并裁剪像素值。  
  - 重构含水印图像并返回原始水印尺寸。  
- `extract_watermark_blind`：  
  - 对含水印图像 Y 通道分块并进行 DCT 变换。  
  - 在相同位置提取二进制水印比特。  
  - 处理尺寸不匹配并重构水印图像。

### 4.5 鲁棒性测试框架

- `attack_*` 系列函数：实现各种图像攻击，如几何和信号处理攻击。  
- `run_robustness_test`：通用测试函数，简化测试流程，包括攻击、提取、计算 NC 和 BER、保存结果。

### 4.6 主执行逻辑

- 输入图像准备：加载用户提供的宿主图像和水印图像，若不存在则自动生成示例图像。  
- 水印流程：依次调用嵌入、无攻击提取和多项鲁棒性测试。  
- 结果汇总：收集并打印所有测试的 NC 和 BER 值。  
- 可视化：使用 `matplotlib` 绘制多子图并保存为 `robustness_summary.png`。

<img width="1506" height="941" alt="image" src="https://github.com/user-attachments/assets/ff6d3c61-76f5-4767-9fd7-dfa4448223ce" />
