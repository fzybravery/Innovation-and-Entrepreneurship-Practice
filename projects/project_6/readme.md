# 基于双重掩码的隐私交集求和协议技术报告  

---

## 1. 项目概述

### 1.1 项目目标

本项目旨在对论文 *“On Deploying Secure Computing: Private Intersection-Sum-with-Cardinality”*（ePrint 2019/723）中第 3.1 节提出的“基于 DDH 的隐私交集求和协议”进行深度剖析与实现验证。我们通过分析 Python 和 C++ 示例代码，阐述该协议如何允许两方（客户端与服务器）在不泄露各自原始数据集的情况下，安全地计算出其数据集的交集大小，并对交集内一方持有的关联数值进行求和。

该协议是 Google 等公司用于“密码泄露检测”等隐私功能的核心技术基础。

### 1.2 技术背景

**核心问题：隐私交集求和（Private Intersection-Sum, PI-Sum）**

PI-Sum 是隐私集合求交（Private Set Intersection, PSI）的扩展：  
- 一方 P1（如用户浏览器）持有一组标识符；  
- 另一方 P2（如服务器）持有一组标识符以及与每个标识符关联的数值；  
- 双方希望计算出交集中的元素数量并求和交集中 P2 的关联值，过程中不泄露各自的非交集数据。

**核心密码学原语：**

- **Diffie-Hellman (DDH) 盲化操作**：利用 \( (H(x)^{k_1})^{k_2} = (H(x)^{k_2})^{k_1} \) 实现双重掩码。
- **Paillier 加法同态加密**：允许在密文上进行加法操作，使得在不解密的情况下实现求和。

---

## 2. 协议深度解析（DDH-based PI-Sum）

该协议通过三轮交互、结合 DDH 盲化与 Paillier 同态加密，实现隐私交集求和。

### 2.1 双重掩码求交集核心思想

双方约定循环群 \( G \) 与哈希函数 \( H \)：

- P1 持有集合 \( V = \{v_i\} \)；
- P2 持有集合 \( W = \{(w_j, t_j)\} \)；

盲化流程：

| 步骤 | P1 操作                           | P2 操作                           |
|------|------------------------------------|------------------------------------|
| 1    | 计算 \( H(v_i)^{k_1} \)            | —                                  |
| 2    | —                                  | 计算 \( H(w_j)^{k_2} \)            |
| 3    | 交换结果并再盲化                   | 交换结果并再盲化                   |
| 4    | 若匹配则为交集 \( H(x)^{k_1k_2} \)  | 若匹配则为交集 \( H(x)^{k_1k_2} \) |

### 2.2 协议流程

#### Setup
- 分享群参数 \( (G, g, p) \)、哈希函数 \( H \)
- P1 选随机 \( k_1 \)，P2 选随机 \( k_2 \)
- P2 生成 Paillier 密钥对 \( (pk,sk) \)，发送 \( pk \) 给 P1

#### Round 1（P1 → P2）
- P1 发送 \( \{H(v_i)^{k_1}\} \)，顺序打乱

#### Round 2（P2 → P1）
- P2 返回 \( \{H(v_i)^{k_1k_2}\} \)（打乱）
- 同时发送 \( \{(h_j=H(w_j)^{k_2}, c_j=Enc_{pk}(t_j))\} \)

#### Round 3（P1）
- P1 计算 \( h_j' = h_j^{k_1} = H(w_j)^{k_2k_1} \)
- 找出属于第二轮返回集合中的元素 → 判定交集
- 将对应 \( c_j \) 同态相乘求和：  
  \( C_{\text{sum}} = \prod c_j \)

#### Output（P2）
- P2 解密：
  \( S = Dec_{sk}(C_{\text{sum}}) = \sum_{j\in \text{Intersection}} t_j \)

---

## 3. 实现与安全性分析

### 3.1 代码映射
- `modexp()`：指数运算（盲化）
- `paillier_*()`：Paillier 系列操作
- `shuffle()`：打乱序列增加匿名性

演示代码使用小素数；实际部署需使用 2048 bit 以上安全参数。

### 3.2 安全性

| 属性       | 说明 |
|------------|------|
| 模型       | 半诚实模型（Honest-but-Curious） |
| 对 P1 隐私 | P2 无法从 \(H(v_i)^{k_1}\) 反推 \(v_i\) |
| 对 P2 隐私 | P1 仅得到交集和求和结果，不泄露非交集元素信息 |
| 安全基础   | DDH 假设、不透露指数；Paillier CPA 安全 |

---

## 4. 结论

该协议通过巧妙结合 DDH 可交换盲化和 Paillier 同态加密，实现了高效、实用、工业可部署的隐私交集求和。

**优势：**

- ✦ *易于实现*：不依赖复杂 MPC 工具  
- ✦ *高效率*：运算 & 通信复杂度线性  
- ✦ *强隐私*：仅泄露交集尺寸与求和结果  

**适用场景：**

- 密码泄露检测  
- 广告转化率归因  
- 安全统计查询  

---
